<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Profile - Poxel Competitive</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://res.cloudinary.com/djttn4xvk/image/upload/v1744016662/iv8s8dkwdzxgnubsnhla.ico">
    <link rel="stylesheet" href="profile-styles.css">

    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <!-- Font Awesome for Pencil Icon (Optional) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- Keep all your existing styles --- */

        /* ======================================== */
        /* Profile Picture Editing Styles         */
        /* ======================================== */
        #profile-pic {
            position: relative; /* Needed for icon positioning */
            width: 120px;
            height: 120px;
            background-color: var(--bg-secondary); /* Fallback color */
            color: var(--text-light); /* Fallback text color */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4.5rem;
            font-weight: 700;
            line-height: 1;
            border: 4px solid var(--primary-orange); /* Adjusted border */
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.4);
            text-transform: uppercase;
            overflow: hidden; /* Important: hide image parts outside circle */
            cursor: default; /* Default cursor */
        }

        #profile-pic img {
            display: block; /* Remove extra space below image */
            width: 100%;
            height: 100%;
            object-fit: cover; /* Scale image nicely */
            border-radius: 50%; /* Ensure image respects the circular boundary */
        }

        #edit-profile-pic-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: none; /* Hidden by default, shown via JS for own profile */
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: background-color 0.2s ease;
        }

        #edit-profile-pic-icon:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        /* Profile Container Background Styling */
        .profile-container {
            position: relative; /* Needed for pseudo-element */
            z-index: 1; /* Ensure content is above pseudo-element */
             /* Keep existing background color as fallback */
            background-color: var(--bg-secondary);
            /* Other styles... */
        }

        .profile-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            opacity: 0; /* Hidden by default */
            z-index: -1; /* Behind the content */
            border-radius: inherit; /* Match container's border radius */
            transition: opacity 0.5s ease-in-out;
            background-image: var(--profile-bg-image, none); /* Use CSS variable */
        }

        .profile-container.has-background::before {
            opacity: 0.5; /* Show with opacity when class is added */
        }


        /* ======================================== */
        /* Image Editing Modal Styles             */
        /* ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 25px 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 15px;
        }

        .modal-header h3 {
            color: var(--primary-orange);
            margin: 0;
            font-size: 1.6rem;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
            padding: 5px;
        }
        .modal-close-btn:hover {
            color: var(--text-light);
        }

        .modal-body {
            flex-grow: 1;
            margin-bottom: 20px;
            overflow: hidden; /* Important for Cropper */
            max-height: calc(90vh - 180px); /* Adjust based on header/footer */
        }

        #cropper-image-container {
            width: 100%;
            height: 100%; /* Container needs height */
            min-height: 300px; /* Ensure minimum space */
        }

        #image-to-crop {
            display: block; /* Cropper requirement */
            max-width: 100%; /* Cropper requirement */
            opacity: 0; /* Hide until Cropper is ready */
        }

        /* Cropper.js specific overrides if needed */
        .cropper-view-box,
        .cropper-face {
          border-radius: 50%; /* Make the crop selection area circular */
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        /* Loading Spinner (Optional) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-orange);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* --- Responsive adjustments for modal/profile pic if needed --- */
        @media (max-width: 768px) {
            #profile-pic { width: 100px; height: 100px; font-size: 3.5rem; border-width: 3px;}
            #edit-profile-pic-icon { width: 25px; height: 25px; font-size: 0.8rem; bottom: 3px; right: 3px; }
            .modal-content { padding: 20px; }
            .modal-header h3 { font-size: 1.4rem; }
            #cropper-image-container { min-height: 250px; }
        }
         @media (max-width: 480px) {
            #profile-pic { width: 85px; height: 85px; font-size: 3rem; border-width: 3px;}
            #edit-profile-pic-icon { width: 22px; height: 22px; font-size: 0.7rem; bottom: 2px; right: 2px; }
            .modal-content { padding: 15px; }
            .modal-header h3 { font-size: 1.3rem; }
            #cropper-image-container { min-height: 200px; }
            .modal-footer { gap: 8px; }
            .btn { padding: 0.6rem 1rem; font-size: 0.9rem; } /* Adjust button padding */
        }

    </style>
</head>
<body>
    <!-- Header -->
    <header>
       <!-- ... (keep existing header) ... -->
    </header>

    <!-- Main Content -->
    <main>
        <!-- Profile Content -->
        <div class="profile-container" id="profile-content" style="display: none;">
            <div class="profile-header">
                <!-- Profile Picture Area -->
                <div id="profile-pic">
                    <span id="profile-initials">?</span> <!-- Fallback Initials -->
                    <img id="profile-image" src="" alt="Profile Picture" style="display: none;"> <!-- Image Tag -->
                    <span id="edit-profile-pic-icon" title="Edit Profile Picture">
                        <i class="fas fa-pencil-alt"></i> <!-- Font Awesome Icon -->
                        <!-- Or use text: ✏️ -->
                    </span>
                </div>
                 <!-- Hidden File Input -->
                <input type="file" id="profile-pic-input" accept="image/png, image/jpeg, image/gif" style="display: none;">

                <div>
                    <!-- ... (keep username, badges, rank, title, email) ... -->
                     <div class="profile-name-container">
                        <h2 id="profile-username">Username</h2>
                        <span id="profile-badges-container"></span>
                        <span id="admin-tag" class="admin-tag">Admin</span>
                    </div>
                    <div class="profile-identifiers">
                        <span id="profile-rank" class="profile-rank-display">...</span>
                        <span id="profile-title" class="profile-title-display" style="display: none;"></span>
                    </div>
                    <p id="profile-email">user@example.com</p>
                </div>
            </div>

            <!-- Stats Sections -->
            <!-- ... (keep competitive and poxel stats sections) ... -->
             <!-- Competitive Stats Section -->
            <div class="profile-stats" id="competitive-stats-section">
                <h3>Competitive Stats</h3>
                <div class="stats-grid" id="stats-display">
                    <p>Loading competitive stats...</p>
                </div>
            </div>

            <!-- Poxel.io Stats Section -->
            <div class="profile-stats" id="poxel-stats-section" style="display: none;">
                <h3>Poxel.io Stats</h3>
                <div class="stats-grid" id="poxel-stats-display">
                    <p>Loading Poxel.io stats...</p>
                </div>
            </div>

        </div>

        <!-- Loading / Not Logged In Messages -->
        <!-- ... (keep existing loading/not logged in divs) ... -->
        <div class="profile-container" id="loading-profile">
            <p>Loading profile...</p>
        </div>
        <div class="profile-container" id="not-logged-in" style="display: none;">
            <p>You need to be logged in to view this page. Redirecting...</p>
        </div>

    </main>

    <!-- Footer -->
    <footer>
       <!-- ... (keep existing footer) ... -->
    </footer>

    <!-- Image Editing Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Profile Picture</h3>
                <button class="modal-close-btn" id="modal-close-btn">×</button>
            </div>
            <div class="modal-body">
                <div id="cropper-image-container">
                    <img id="image-to-crop" src="" alt="Image to crop">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel-btn">Cancel</button>
                <button class="btn btn-primary" id="modal-apply-btn">
                    Apply
                    <span class="spinner" id="modal-spinner" style="display: none;"></span>
                 </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK Scripts -->
    <!-- ... (keep existing Firebase scripts) ... -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <!-- Cropper.js Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- Cloudinary Script (Using Upload Widget for simplicity) -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <!-- Your Profile Script -->
    <script src="profile.js"></script>

</body>
</html>
